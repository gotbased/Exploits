import os
import re
import csv
import subprocess
import uuid
from datetime import datetime

def run_msfconsole_with_resource(resource_content):
    resource_file_name = f'temp_resource_{str(uuid.uuid4())}.rc'
    with open(resource_file_name, 'w') as resource_file:
        resource_file.write(resource_content)

    msfconsole = subprocess.Popen(['msfconsole', '-r', resource_file_name], stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    stdout, stderr = msfconsole.communicate()
    os.remove(resource_file_name)

    if msfconsole.returncode != 0:
        raise Exception(f"Error running msfconsole command: {stderr}")
    return stdout

def search_cve(resource_content, cve):
    resource_content += f'search cve:{cve} check:yes\nsearch cve:{cve}\nsearch cve:{cve} type:auxiliary\nexit\n'
    return run_msfconsole_with_resource(resource_content)

def process_cve_file(file_path):
    with open(file_path, 'r') as file:
        cve_list = [cve.strip() for cve in file.readlines() if cve.strip()]

    results = []

    for cve in cve_list:
        print(f"Searching for: {cve}")
        print("=============")
        result = search_cve('', cve)

        module_lines = [[] for _ in range(3)]
        resource_content = ''

        for line in result.splitlines():
            if re.match(r'^\s{2,}\d+\s+([a-zA-Z_]+\/[a-zA-Z_]+\/[a-zA-Z_]+)', line):
                module_lines[0 if "check:yes" in resource_content else 1 if "type:auxiliary" in resource_content else 2].append(line)

            if not resource_content:
                resource_content = 'search cve:' + cve

        results.append((cve, module_lines))

    # Save the results to CSV files
    os.makedirs("results", exist_ok=True)
    today = datetime.now().strftime("%Y-%m-%d")
    csv_file_check = f'results/cve_checks_{today}.csv'
    csv_file_all = f'results/cve_all_{today}.csv'
    csv_file_auxiliary = f'results/auxiliary_{today}.csv'

    write_to_csv(csv_file_check, ['CVE', 'Matching Modules'], results, 0)
    write_to_csv(csv_file_all, ['CVE', 'Matching Modules'], results, 1)
    write_to_csv(csv_file_auxiliary, ['CVE', 'Auxiliary Modules'], results, 2)

def write_to_csv(file_path, header, data, idx):
    with open(file_path, 'w', newline='') as csvfile:
        csv_writer = csv.writer(csvfile)
        csv_writer.writerow(header)
        for cve, modules in data:
            if modules[idx]:
                for module in modules[idx]:
                    csv_writer.writerow([cve, module.strip()])
            else:
                csv_writer.writerow([cve, "No Modules Found"])

if __name__ == "__main__":
    import sys
    if len(sys.argv) != 2:
        print("Usage: python run.py <cve_list_file>")
        sys.exit(1)
    process_cve_file(sys.argv[1])
